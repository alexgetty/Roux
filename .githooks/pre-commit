#!/bin/bash

# Release commit validator
# If package.json version is changing, only allow: CHANGELOG.md, package.json, package-lock.json

# Get staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if package.json is staged
if ! echo "$STAGED_FILES" | grep -q "^package.json$"; then
    # Not a release commit, allow anything
    exit 0
fi

# Check if version is changing
OLD_VERSION=$(git show HEAD:package.json 2>/dev/null | grep '"version"' | head -1 | sed 's/.*: *"\([^"]*\)".*/\1/')
NEW_VERSION=$(git diff --cached package.json | grep '^\+.*"version"' | head -1 | sed 's/.*: *"\([^"]*\)".*/\1/')

if [ -z "$NEW_VERSION" ]; then
    # Version not changing, not a release commit
    exit 0
fi

# This is a release commit - enforce file allowlist
ALLOWED_FILES="CHANGELOG.md
package.json
package-lock.json"

for file in $STAGED_FILES; do
    if ! echo "$ALLOWED_FILES" | grep -q "^${file}$"; then
        echo "ERROR: Release commits can only contain CHANGELOG.md, package.json, package-lock.json"
        echo "Found unexpected staged file: $file"
        echo ""
        echo "Unstage extra files or commit them separately before releasing."
        exit 1
    fi
done

# Verify CHANGELOG.md is present
if ! echo "$STAGED_FILES" | grep -q "^CHANGELOG.md$"; then
    echo "ERROR: Release commits must include CHANGELOG.md"
    echo ""
    echo "Run /release to generate changelog before publishing."
    exit 1
fi

echo "Release commit validated: version $OLD_VERSION -> $NEW_VERSION"
exit 0
