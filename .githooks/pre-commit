#!/bin/bash

# Release commit validator
# If package.json version is changing:
# 1. Only allow release-related files
# 2. Verify CHANGELOG.md was updated since last release tag

STAGED_FILES=$(git diff --cached --name-only)

# Check if package.json is staged
if ! echo "$STAGED_FILES" | grep -q "^package.json$"; then
    exit 0
fi

# Check if version is changing
OLD_VERSION=$(git show HEAD:package.json 2>/dev/null | grep '"version"' | head -1 | sed 's/.*: *"\([^"]*\)".*/\1/')
NEW_VERSION=$(git diff --cached package.json | grep '^\+.*"version"' | head -1 | sed 's/.*: *"\([^"]*\)".*/\1/')

if [ -z "$NEW_VERSION" ]; then
    exit 0
fi

# This is a release commit - enforce file allowlist
ALLOWED_FILES="CHANGELOG.md
package.json
package-lock.json"

for file in $STAGED_FILES; do
    if ! echo "$ALLOWED_FILES" | grep -q "^${file}$"; then
        echo "ERROR: Release commits can only contain CHANGELOG.md, package.json, package-lock.json"
        echo "Found unexpected staged file: $file"
        echo ""
        echo "Unstage extra files or commit them separately before releasing."
        exit 1
    fi
done

# Verify CHANGELOG.md was updated since last release tag
LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)

if [ -z "$LAST_TAG" ]; then
    echo "Release commit validated: version $OLD_VERSION -> $NEW_VERSION (first release)"
    exit 0
fi

CHANGELOG_COMMITS=$(git log "$LAST_TAG"..HEAD --oneline -- CHANGELOG.md | wc -l | tr -d ' ')

if [ "$CHANGELOG_COMMITS" -eq 0 ]; then
    echo "ERROR: CHANGELOG.md has not been updated since $LAST_TAG"
    echo ""
    echo "Run /release to generate changelog before publishing."
    exit 1
fi

echo "Release commit validated: version $OLD_VERSION -> $NEW_VERSION"
exit 0
